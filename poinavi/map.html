<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="default" />
    <meta name="apple-mobile-web-app-title" content="ぽいナビ" />
    <meta name="theme-color" content="#ffffff" />
    <title>ぽいナビ - 地図</title>
    <meta
      name="description"
      content="現在地から近い店舗・スポットを直感的に検索・ナビゲーション"
    />
    <link rel="icon" type="image/png" href="favicon.png" />
    <link rel="apple-touch-icon" href="icon-192.png" />
    <link rel="manifest" href="manifest.json" />
    <link rel="stylesheet" href="./style.css" />
    <!-- Google Maps API -->
    <script
      src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDA62Ge5UHqpZOFQhMhVSvQI_xWABrftL0&libraries=places,geometry&callback=initGoogleMaps"
      defer
    ></script>
    <script>
      // Google Maps API の読み込みエラーハンドリング
      window.gm_authFailure = function() {
        showMapError("Google Maps API の認証に失敗しました。APIキーを確認してください。");
      };

      // APIキーチェック
      function checkApiKey() {
        const scriptTag = document.querySelector('script[src*="maps.googleapis.com"]');
        if (scriptTag && scriptTag.src.includes('YOUR_GOOGLE_MAPS_API_KEY')) {
          showMapError(
            "Google Maps API キーが設定されていません。\n\n" +
            "map.html の14行目付近の YOUR_GOOGLE_MAPS_API_KEY を実際のAPIキーに置き換えてください。\n\n" +
            "APIキーの取得方法:\n" +
            "1. https://console.cloud.google.com/ にアクセス\n" +
            "2. プロジェクトを作成\n" +
            "3. Maps JavaScript API と Places API を有効化\n" +
            "4. API キーを取得して設定"
          );
          return false;
        }
        return true;
      }

      function showMapError(message) {
        const mapContainer = document.getElementById("map");
        if (mapContainer) {
          mapContainer.innerHTML = `
            <div style="
              display: flex;
              flex-direction: column;
              align-items: center;
              justify-content: center;
              height: 100%;
              padding: 20px;
              text-align: center;
              background-color: #f5f5f5;
              color: #d32f2f;
            ">
              <div style="font-size: 48px; margin-bottom: 16px;">⚠️</div>
              <div style="font-size: 18px; font-weight: 600; margin-bottom: 12px;">マップの読み込みエラー</div>
              <div style="font-size: 14px; line-height: 1.6; white-space: pre-line;">${message}</div>
            </div>
          `;
        }
      }

      // ページ読み込み時にAPIキーをチェック
      window.addEventListener("DOMContentLoaded", function() {
        setTimeout(function() {
          if (typeof google === "undefined" || typeof google.maps === "undefined") {
            if (!checkApiKey()) {
              return;
            }
            showMapError(
              "Google Maps API が読み込めませんでした。\n\n" +
              "考えられる原因:\n" +
              "・APIキーが正しく設定されていない\n" +
              "・Maps JavaScript API が有効化されていない\n" +
              "・ネットワーク接続の問題\n\n" +
              "ブラウザのコンソール（F12）でエラー詳細を確認してください。"
            );
          }
        }, 2000); // 2秒後にチェック
      });
    </script>
  </head>
  <body class="light-mode">
    <!-- ローディング画面 -->
    <div id="loadingOverlay" class="loading-overlay">
      <div class="loading-spinner">
        <div class="spinner"></div>
        <p class="loading-text">現在地を取得中...</p>
      </div>
    </div>

    <!-- 現在地住所モーダル -->
    <div id="locationModal" class="location-modal hidden">
      <div class="location-modal__overlay"></div>
      <div class="location-modal__content">
        <div class="location-modal__header">
          <h2 class="location-modal__title">現在地</h2>
          <button class="location-modal__close" id="locationModalClose" aria-label="閉じる">×</button>
        </div>
        <div class="location-modal__body">
          <p class="location-modal__address" id="locationModalAddress">住所を取得中...</p>
        </div>
      </div>
    </div>

    <!-- 設定モーダル -->
    <div id="settingsModal" class="settings-modal hidden">
      <div class="settings-modal__overlay"></div>
      <div class="settings-modal__content">
        <div class="settings-modal__header">
          <h2 class="settings-modal__title">設定</h2>
          <button class="settings-modal__close" id="settingsModalClose" aria-label="閉じる">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <line x1="18" y1="6" x2="6" y2="18"></line>
              <line x1="6" y1="6" x2="18" y2="18"></line>
            </svg>
          </button>
        </div>
        <div class="settings-modal__body">
          <!-- タグ管理 -->
          <div class="settings-modal__item settings-modal__item--tags">
            <label class="settings-modal__label">タグ管理</label>
            
            <!-- タグ追加フォーム -->
            <div class="tag-add-form">
              <input 
                type="text" 
                id="newTagInput" 
                class="tag-add-form__input" 
                placeholder="新しいタグ名"
                maxlength="20"
              />
              <button id="addTagButton" class="tag-add-form__button" type="button">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                  <line x1="12" y1="5" x2="12" y2="19"></line>
                  <line x1="5" y1="12" x2="19" y2="12"></line>
                </svg>
                追加
              </button>
            </div>
            
            <!-- タグ一覧（削除可能） -->
            <div class="tag-manage-list" id="tagManageList">
              <!-- JavaScriptで動的に生成 -->
            </div>
          </div>
          
          <!-- 移動手段 -->
          <div class="settings-modal__item">
            <label class="settings-modal__label">移動手段</label>
            <div class="transport-mode-buttons">
              <button type="button" class="transport-mode-btn active" data-mode="walk">
                🚶 徒歩
              </button>
              <button type="button" class="transport-mode-btn" data-mode="bicycle">
                🚲 自転車
              </button>
              <button type="button" class="transport-mode-btn" data-mode="car">
                🚗 車
              </button>
            </div>
          </div>
          
          <!-- テーマ切り替え -->
          <div class="settings-modal__item">
            <label class="settings-modal__label">テーマ</label>
            <button id="themeToggle" class="settings-modal__theme-toggle">
              <span class="theme-icon">🌙</span>
              <span class="theme-text">ダークモード</span>
            </button>
          </div>
          
          <!-- 表示件数 -->
          <div class="settings-modal__item">
            <label class="settings-modal__label">表示件数</label>
            <select id="resultCount" class="settings-modal__select">
              <option value="3">3件</option>
              <option value="4">4件</option>
              <option value="5" selected>5件</option>
            </select>
          </div>
          
          <!-- 営業中のみ表示 -->
          <div class="settings-modal__item">
            <label class="settings-modal__label settings-modal__label--checkbox">
              <input type="checkbox" id="openOnly" class="settings-modal__checkbox" />
              <span class="settings-modal__checkbox-custom"></span>
              営業中のみ表示
            </label>
          </div>
        </div>
      </div>
    </div>

    <!-- 1️⃣ マップ表示（上部） -->
    <main class="main-content">
      <div class="map-container">
        <div id="map" class="map"></div>
        
        <!-- 設定ボタン（右上フロート） -->
        <button id="mapSettingsButton" class="map-settings-button" type="button" aria-label="設定">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <circle cx="12" cy="12" r="3"></circle>
            <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path>
          </svg>
        </button>
        
        <!-- レイヤーコントロール（左上フロート） -->
        <div class="layer-control">
          <!-- 鉄道レイヤートグル -->
          <button 
            id="railwayToggle" 
            class="layer-toggle" 
            type="button"
            aria-pressed="false"
            aria-label="鉄道路線切替"
          >
            <svg class="layer-toggle__icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <rect x="4" y="3" width="16" height="18" rx="2"></rect>
              <line x1="12" y1="8" x2="12" y2="21"></line>
              <line x1="8" y1="8" x2="8" y2="8.01"></line>
              <line x1="16" y1="8" x2="16" y2="8.01"></line>
              <path d="M4 11h16"></path>
              <circle cx="8.5" cy="15.5" r="1.5"></circle>
              <circle cx="15.5" cy="15.5" r="1.5"></circle>
            </svg>
            <span class="layer-toggle__text">鉄道</span>
          </button>
          
          <!-- 雨雲レーダートグル -->
          <button 
            id="rainViewerToggle" 
            class="layer-toggle" 
            type="button"
            aria-pressed="false"
            aria-label="雨雲レーダー切替"
          >
            <svg class="layer-toggle__icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M20 17.58A5 5 0 0 0 18 8h-1.26A8 8 0 1 0 4 16.25"></path>
              <line x1="8" y1="16" x2="8.01" y2="16"></line>
              <line x1="8" y1="20" x2="8.01" y2="20"></line>
              <line x1="12" y1="18" x2="12.01" y2="18"></line>
              <line x1="12" y1="22" x2="12.01" y2="22"></line>
              <line x1="16" y1="16" x2="16.01" y2="16"></line>
              <line x1="16" y1="20" x2="16.01" y2="20"></line>
            </svg>
            <span class="layer-toggle__text">雨雲</span>
          </button>
          
          <!-- 鉄道ON時のステータスパネル -->
          <div id="railwayStatus" class="layer-status hidden">
            <div class="layer-status__title">鉄道路線表示中</div>
            <div class="layer-status__desc">半径10km以内の路線・駅</div>
          </div>
          
          <!-- 雨雲ON時のステータスパネル -->
          <div id="rainViewerStatus" class="layer-status hidden">
            <div class="layer-status__title">雨雲観測モード</div>
            <div class="layer-status__desc">降雨状況の参考表示です</div>
          </div>
        </div>
        
        <!-- 免責表示（常時） -->
        <div class="rain-viewer-disclaimer">
          ※ 天気情報は参考表示です。実際の状況は現地でご確認ください。
        </div>
        
        <!-- トップ3～5件リスト（距離順） -->
        <div class="results-list" id="resultsList"></div>
      </div>
    </main>

    <!-- 2️⃣ 設定バー（画面下部・noteバナーの上） -->
    <div class="settings-bar">
      <button class="settings-bar__toggle" id="settingsToggle" aria-label="設定を開閉">
        <span class="settings-bar__toggle-icon">▲</span>
      </button>
      <div class="settings-bar__inner" id="settingsContent">
        <!-- 1行目: 検索テキスト入力 -->
        <section class="settings-section">
          <div class="search-row">
            <div class="search-group">
              <input
                type="text"
                id="searchInput"
                class="search-input"
                placeholder="研究所"
              />
            <button id="searchButton" class="search-button" type="button" aria-label="検索">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                <circle cx="11" cy="11" r="8"></circle>
                <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
              </svg>
            </button>
            </div>
          </div>
        </section>

        <!-- 2行目: タグ選択（JavaScriptで動的に生成） -->
        <section class="settings-section">
          <div class="tag-list" id="tagList">
            <!-- タグはJavaScriptで動的に生成されます -->
          </div>
        </section>
      </div>
    </div>

    <!-- フッターナビゲーション -->
    <footer class="footer-nav">
      <a href="./translate.html" class="footer-nav__item">
        <svg class="footer-nav__icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"></path>
          <path d="M19 10v2a7 7 0 0 1-14 0v-2"></path>
          <line x1="12" y1="19" x2="12" y2="23"></line>
          <line x1="8" y1="23" x2="16" y2="23"></line>
        </svg>
        <span class="footer-nav__label">翻訳</span>
      </a>
      <a href="./index.html" class="footer-nav__item">
        <svg class="footer-nav__icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
          <polyline points="14 2 14 8 20 8"></polyline>
          <line x1="16" y1="13" x2="8" y2="13"></line>
          <line x1="16" y1="17" x2="8" y2="17"></line>
          <polyline points="10 9 9 9 8 9"></polyline>
        </svg>
        <span class="footer-nav__label">メモ</span>
      </a>
      <a href="./map.html" class="footer-nav__item footer-nav__item--active">
        <svg class="footer-nav__icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <polygon points="1 6 1 22 8 18 16 22 23 18 23 2 16 6 8 2 1 6"></polygon>
          <line x1="8" y1="2" x2="8" y2="18"></line>
          <line x1="16" y1="6" x2="16" y2="22"></line>
        </svg>
        <span class="footer-nav__label">地図</span>
      </a>
    </footer>

    <script src="./script.js"></script>
  </body>
</html>
