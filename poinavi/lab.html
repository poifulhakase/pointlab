<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <!-- ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ˜ãƒƒãƒ€ãƒ¼ -->
    <meta http-equiv="X-Content-Type-Options" content="nosniff" />
    <meta name="referrer" content="strict-origin-when-cross-origin" />
    <!-- Google Analytics 4 (è‡ªåˆ†é™¤å¤–å¯¾å¿œ) -->
    <script>
      // localStorage.setItem('excludeFromAnalytics', 'true') ã‚’ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã§å®Ÿè¡Œã™ã‚‹ã¨é™¤å¤–
      if (localStorage.getItem('excludeFromAnalytics') !== 'true') {
        var script = document.createElement('script');
        script.async = true;
        script.src = 'https://www.googletagmanager.com/gtag/js?id=G-ERDSPE9CZM';
        document.head.appendChild(script);
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-ERDSPE9CZM');
      }
    </script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <meta name="mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="default" />
    <meta name="apple-mobile-web-app-title" content="ã½ã„ãƒŠãƒ“" />
    <meta name="theme-color" content="#ffffff" />
    <title>ã½ã„ãƒŠãƒ“ - ç ”ç©¶å®¤</title>
    <meta name="description" content="åœ°å›³ãƒ»ç¿»è¨³ãƒ»ãƒ©ãƒœãƒãƒ¼ãƒˆã€‚æ—…å…ˆã§ã€Œä»Šã™ãä½¿ã„ãŸã„ã€æ©Ÿèƒ½ã‚’ã²ã¨ã¤ã«ã€‚" />
    <link rel="icon" type="image/png" href="favicon.png" />
    <link rel="apple-touch-icon" href="icon-192.png" />
    <link rel="manifest" href="manifest.json" />
    <link rel="stylesheet" href="./style.css?v=126" />
    <!-- FOUCå¯¾ç­–: CSSãƒ­ãƒ¼ãƒ‰å‰ã«ãƒ†ãƒ¼ãƒã‚’é©ç”¨ -->
    <script>
      (function() {
        var theme = localStorage.getItem("poinavi_theme") || "light";
        document.documentElement.className = theme === "dark" ? "dark-mode" : "light-mode";
      })();
    </script>
    <style>
      /* FOUCå¯¾ç­–: åˆæœŸèƒŒæ™¯è‰² */
      html.light-mode { background-color: #f5f5f7; }
      html.dark-mode { background-color: #1a1a1a; }
    </style>
  </head>
  <body>
    <!-- é•·æŠ¼ã—ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆãƒ¡ãƒ‹ãƒ¥ãƒ¼ç„¡åŠ¹åŒ– -->
    <script>
      document.addEventListener('contextmenu', function(e) { e.preventDefault(); });
    </script>
    <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
    <header class="translate-header">
      <!-- å·¦å´ã®ã‚¹ãƒšãƒ¼ã‚µãƒ¼ -->
      <div class="translate-header__icon-btn translate-header__icon-btn--invisible"></div>
      
      <a href="https://note.com/pointlab/magazines" target="_blank" rel="noopener noreferrer" class="translate-header__title">
        <img src="./poinabi.svg" alt="ã½ã„ã‚“ã¨ã‚‰ã¼" class="translate-header__logo" style="height: 28px; width: auto;" />
      </a>
      
      <!-- è¨­å®šãƒœã‚¿ãƒ³ï¼ˆå³ä¸Šï¼‰ -->
      <button id="labSettingsButton" class="translate-header__icon-btn translate-header__icon-btn--right" type="button" aria-label="è¨­å®š">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <circle cx="12" cy="12" r="3"></circle>
          <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path>
        </svg>
      </button>
    </header>

    <!-- è¨­å®šãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="labSettingsModal" class="translate-modal hidden">
      <div class="translate-modal__overlay"></div>
      <div class="translate-modal__content">
        <div class="translate-modal__header">
          <h2 class="translate-modal__title">è¨­å®š</h2>
          <button class="translate-modal__close" id="labSettingsClose" aria-label="é–‰ã˜ã‚‹">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <line x1="18" y1="6" x2="6" y2="18"></line>
              <line x1="6" y1="6" x2="18" y2="18"></line>
            </svg>
          </button>
        </div>
        <div class="translate-modal__body">
          <!-- èµ·å‹•ãƒšãƒ¼ã‚¸ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
          <div class="translate-modal__section">
            <div class="translate-modal__section-title">ãƒˆãƒƒãƒ—è¡¨ç¤º</div>
            <select id="labStartPageSelect" class="translate-modal__select">
              <option value="index.html">ğŸ“ ãƒ©ãƒœãƒãƒ¼ãƒˆ</option>
              <option value="translate.html">ğŸŒ ç¿»è¨³</option>
              <option value="map.html">ğŸ—ºï¸ ã½ã„ãƒŠãƒ“</option>
              <option value="lab.html">ğŸ”¬ ç ”ç©¶å®¤</option>
            </select>
          </div>
          <!-- ãƒ†ãƒ¼ãƒã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
          <div class="translate-modal__section">
            <div class="translate-modal__section-title">ãƒ†ãƒ¼ãƒ</div>
            <button id="labThemeToggle" class="translate-modal__theme-toggle">
              <span class="theme-icon">â˜€ï¸</span>
              <span class="theme-text">ãƒ©ã‚¤ãƒˆãƒ¢ãƒ¼ãƒ‰</span>
            </button>
          </div>
          <!-- ãƒªã‚»ãƒƒãƒˆã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
          <div class="translate-modal__section">
            <div class="translate-modal__section-title">ãƒ‡ãƒ¼ã‚¿ç®¡ç†</div>
            <button id="labResetButton" class="translate-modal__reset-btn">
              è¨­å®šã‚’åˆæœŸåŒ–
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
    <main class="lab-main">
      <!-- æ—¥ä»˜ãƒ»æ™‚åˆ»ã‚¨ãƒªã‚¢ï¼ˆãƒ¡ã‚¤ãƒ³ï¼‰ -->
      <div class="lab-hero">
        <div class="lab-hero__time" id="labTime">--:--</div>
        <div class="lab-hero__date" id="labDate">----å¹´--æœˆ--æ—¥</div>
        <div class="lab-hero__day" id="labDay">--æ›œæ—¥</div>
      </div>

      <!-- ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã‚«ãƒ¼ãƒ‰ -->
      <div class="lab-dashboard">
        <!-- å¤©æ°—ã‚«ãƒ¼ãƒ‰ -->
        <div class="lab-card lab-card--weather">
          <div class="lab-card__icon" id="weatherIcon">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
              <circle cx="12" cy="12" r="5"/>
              <line x1="12" y1="1" x2="12" y2="3"/>
              <line x1="12" y1="21" x2="12" y2="23"/>
              <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/>
              <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/>
              <line x1="1" y1="12" x2="3" y2="12"/>
              <line x1="21" y1="12" x2="23" y2="12"/>
              <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/>
              <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/>
            </svg>
          </div>
          <div class="lab-card__content">
            <div class="lab-card__label">å¤©æ°—</div>
            <div class="lab-card__value" id="weatherText">å–å¾—ä¸­...</div>
          </div>
        </div>

        <!-- æ°—æ¸©ã‚«ãƒ¼ãƒ‰ -->
        <div class="lab-card lab-card--temp">
          <div class="lab-card__icon">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
              <path d="M14 14.76V3.5a2.5 2.5 0 0 0-5 0v11.26a4.5 4.5 0 1 0 5 0z"/>
            </svg>
          </div>
          <div class="lab-card__content">
            <div class="lab-card__label">æ°—æ¸©</div>
            <div class="lab-card__value" id="tempValue">--Â°C</div>
          </div>
        </div>

        <!-- ç§»å‹•æ™‚é–“ã‚«ãƒ¼ãƒ‰ -->
        <div class="lab-card lab-card--travel">
          <div class="lab-card__icon">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
              <circle cx="12" cy="12" r="10"/>
              <polyline points="12 6 12 12 16 14"/>
            </svg>
          </div>
          <div class="lab-card__content">
            <div class="lab-card__label">ç§»å‹•æ™‚é–“</div>
            <div class="lab-card__value" id="travelTime">--åˆ†</div>
          </div>
        </div>

        <!-- æ­©æ•°ã‚«ãƒ¼ãƒ‰ -->
        <div class="lab-card lab-card--steps">
          <div class="lab-card__icon">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
              <path d="M4 16v-2.38C4 11.5 2.97 10.5 3 8c.03-2.72 1.49-6 4.5-6C9.5 2 10 3.5 10 5c0 1.03-.4 2-1 3"/>
              <path d="M10 5c1 0 2 .5 2 2 0 1.03-.4 2-1 3"/>
              <path d="M20 16v-2.38c0-2.12 1.03-3.12 1-5.62-.03-2.72-1.49-6-4.5-6C14.5 2 14 3.5 14 5c0 1.03.4 2 1 3"/>
              <path d="M14 5c-1 0-2 .5-2 2 0 1.03.4 2 1 3"/>
              <path d="M4 22v-6h4l1.5-3 2.5 6 2-3h4v6"/>
            </svg>
          </div>
          <div class="lab-card__content">
            <div class="lab-card__label">æ­©æ•°</div>
            <div class="lab-card__value" id="stepsValue">--æ­©</div>
          </div>
        </div>
      </div>

      <!-- æ­©æ•°å…¥åŠ›ã‚¨ãƒªã‚¢ -->
      <div class="lab-steps-input">
        <label class="lab-steps-input__label">ä»Šæ—¥ã®æ­©æ•°ã‚’è¨˜éŒ²</label>
        <div class="lab-steps-input__row">
          <input type="number" id="stepsInput" class="lab-steps-input__field" placeholder="æ­©æ•°ã‚’å…¥åŠ›" min="0" step="100" />
          <button id="stepsSubmit" class="lab-steps-input__btn">è¨˜éŒ²</button>
        </div>
      </div>

      <!-- æ­©æ•°å±¥æ­´ -->
      <div class="lab-history">
        <div class="lab-history__title">æ­©æ•°å±¥æ­´ï¼ˆéå»7æ—¥é–“ï¼‰</div>
        <div class="lab-history__chart" id="stepsChart">
          <!-- JSã§æç”» -->
        </div>
      </div>
    </main>

    <!-- ãƒ•ãƒƒã‚¿ãƒ¼ -->
    <footer class="translate-footer">
      <a href="./index.html" class="translate-footer__btn" aria-label="ãƒ©ãƒœãƒãƒ¼ãƒˆãƒšãƒ¼ã‚¸ã¸">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
          <polyline points="14 2 14 8 20 8"></polyline>
          <line x1="16" y1="13" x2="8" y2="13"></line>
          <line x1="16" y1="17" x2="8" y2="17"></line>
          <polyline points="10 9 9 9 8 9"></polyline>
        </svg>
        <span class="translate-footer__label">ãƒ©ãƒœãƒãƒ¼ãƒˆ</span>
      </a>
      <a href="./translate.html" class="translate-footer__btn" aria-label="ç¿»è¨³ãƒšãƒ¼ã‚¸ã¸">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M5 8l6 6"/>
          <path d="M4 14h6"/>
          <path d="M2 5h12"/>
          <path d="M7 2v3"/>
          <path d="M22 22l-5-10-5 10"/>
          <path d="M14 18h6"/>
        </svg>
        <span class="translate-footer__label">ç¿»è¨³</span>
      </a>
      <a href="./map.html" class="translate-footer__btn" aria-label="ã½ã„ãƒŠãƒ“ãƒšãƒ¼ã‚¸ã¸">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <polygon points="1 6 1 22 8 18 16 22 23 18 23 2 16 6 8 2 1 6"/>
          <line x1="8" y1="2" x2="8" y2="18"/>
          <line x1="16" y1="6" x2="16" y2="22"/>
        </svg>
        <span class="translate-footer__label">ã½ã„ãƒŠãƒ“</span>
      </a>
      <span class="translate-footer__btn translate-footer__btn--active" aria-label="ç ”ç©¶å®¤ãƒšãƒ¼ã‚¸ï¼ˆç¾åœ¨ã®ãƒšãƒ¼ã‚¸ï¼‰">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M9 3H5a2 2 0 0 0-2 2v4m6-6h10a2 2 0 0 1 2 2v4M9 3v18m0 0h10a2 2 0 0 0 2-2v-4M9 21H5a2 2 0 0 1-2-2v-4m0-6v6"/>
          <circle cx="6" cy="12" r="1"/>
          <circle cx="18" cy="8" r="1"/>
          <circle cx="15" cy="16" r="1"/>
        </svg>
        <span class="translate-footer__label">ç ”ç©¶å®¤</span>
      </span>
    </footer>

    <script>
      // ============================================
      // ãƒ†ãƒ¼ãƒç®¡ç†
      // ============================================
      function initTheme() {
        const savedTheme = localStorage.getItem("poinavi_theme") || "light";
        applyTheme(savedTheme);
        updateThemeButton(savedTheme);
      }

      function applyTheme(theme) {
        document.documentElement.className = theme === "dark" ? "dark-mode" : "light-mode";
        document.body.className = theme === "dark" ? "dark-mode" : "light-mode";
      }

      function updateThemeButton(theme) {
        const themeToggle = document.getElementById("labThemeToggle");
        if (!themeToggle) return;
        const icon = themeToggle.querySelector(".theme-icon");
        const text = themeToggle.querySelector(".theme-text");
        if (theme === "dark") {
          icon.textContent = "ğŸŒ™";
          text.textContent = "ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰";
        } else {
          icon.textContent = "â˜€ï¸";
          text.textContent = "ãƒ©ã‚¤ãƒˆãƒ¢ãƒ¼ãƒ‰";
        }
      }

      function initThemeToggle() {
        const themeToggle = document.getElementById("labThemeToggle");
        if (!themeToggle) return;
        themeToggle.addEventListener("click", function() {
          const currentTheme = localStorage.getItem("poinavi_theme") || "light";
          const newTheme = currentTheme === "dark" ? "light" : "dark";
          localStorage.setItem("poinavi_theme", newTheme);
          applyTheme(newTheme);
          updateThemeButton(newTheme);
        });
      }

      // ============================================
      // è¨­å®šãƒ¢ãƒ¼ãƒ€ãƒ«
      // ============================================
      function initSettingsModal() {
        const settingsButton = document.getElementById("labSettingsButton");
        const settingsModal = document.getElementById("labSettingsModal");
        const settingsClose = document.getElementById("labSettingsClose");
        const overlay = settingsModal.querySelector(".translate-modal__overlay");

        settingsButton.addEventListener("click", function() {
          settingsModal.classList.remove("hidden");
        });

        function closeModal() {
          settingsModal.classList.add("hidden");
        }

        settingsClose.addEventListener("click", closeModal);
        overlay.addEventListener("click", closeModal);
      }

      function initStartPageSelect() {
        const startPageSelect = document.getElementById("labStartPageSelect");
        const savedStartPage = localStorage.getItem("poinavi_start_page") || "index.html";
        startPageSelect.value = savedStartPage;
        
        startPageSelect.addEventListener("change", function() {
          localStorage.setItem("poinavi_start_page", this.value);
        });
      }

      function initResetButton() {
        const resetButton = document.getElementById("labResetButton");
        resetButton.addEventListener("click", function() {
          if (!confirm("è¨­å®šã‚’åˆæœŸåŒ–ã—ã¾ã™ã‹ï¼Ÿæ­©æ•°ãƒ‡ãƒ¼ã‚¿ã¯ä¿æŒã•ã‚Œã¾ã™ã€‚")) return;
          localStorage.removeItem("poinavi_theme");
          localStorage.removeItem("poinavi_start_page");
          alert("è¨­å®šã‚’åˆæœŸåŒ–ã—ã¾ã—ãŸã€‚ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¾ã™ã€‚");
          location.reload();
        });
      }

      // ============================================
      // æ—¥ä»˜ãƒ»æ™‚åˆ»è¡¨ç¤º
      // ============================================
      function updateDateTime() {
        const now = new Date();
        const timeEl = document.getElementById("labTime");
        const dateEl = document.getElementById("labDate");
        const dayEl = document.getElementById("labDay");
        
        const hours = String(now.getHours()).padStart(2, "0");
        const minutes = String(now.getMinutes()).padStart(2, "0");
        timeEl.textContent = `${hours}:${minutes}`;
        
        const year = now.getFullYear();
        const month = now.getMonth() + 1;
        const date = now.getDate();
        dateEl.textContent = `${year}å¹´${month}æœˆ${date}æ—¥`;
        
        const days = ["æ—¥", "æœˆ", "ç«", "æ°´", "æœ¨", "é‡‘", "åœŸ"];
        dayEl.textContent = `${days[now.getDay()]}æ›œæ—¥`;
      }

      // ============================================
      // å¤©æ°—å–å¾—ï¼ˆOpen-Meteo API - ç„¡æ–™ï¼‰
      // ============================================
      const weatherCodeMap = {
        0: { text: "å¿«æ™´", icon: "clear" },
        1: { text: "æ™´ã‚Œ", icon: "clear" },
        2: { text: "ã‚„ã‚„æ›‡ã‚Š", icon: "partly_cloudy" },
        3: { text: "æ›‡ã‚Š", icon: "cloudy" },
        45: { text: "éœ§", icon: "fog" },
        48: { text: "éœ§", icon: "fog" },
        51: { text: "å°é›¨", icon: "drizzle" },
        53: { text: "é›¨", icon: "drizzle" },
        55: { text: "é›¨", icon: "drizzle" },
        61: { text: "å°é›¨", icon: "rain" },
        63: { text: "é›¨", icon: "rain" },
        65: { text: "å¤§é›¨", icon: "rain" },
        71: { text: "å°é›ª", icon: "snow" },
        73: { text: "é›ª", icon: "snow" },
        75: { text: "å¤§é›ª", icon: "snow" },
        80: { text: "ã«ã‚ã‹é›¨", icon: "rain" },
        81: { text: "é›¨", icon: "rain" },
        82: { text: "å¤§é›¨", icon: "rain" },
        95: { text: "é›·é›¨", icon: "thunderstorm" },
        96: { text: "é›·é›¨", icon: "thunderstorm" },
        99: { text: "é›·é›¨", icon: "thunderstorm" }
      };

      function getWeatherIcon(iconType) {
        const icons = {
          clear: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
            <circle cx="12" cy="12" r="5"/>
            <line x1="12" y1="1" x2="12" y2="3"/>
            <line x1="12" y1="21" x2="12" y2="23"/>
            <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/>
            <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/>
            <line x1="1" y1="12" x2="3" y2="12"/>
            <line x1="21" y1="12" x2="23" y2="12"/>
            <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/>
            <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/>
          </svg>`,
          partly_cloudy: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
            <path d="M12 2v2"/>
            <path d="M4.93 4.93l1.41 1.41"/>
            <path d="M20 12h2"/>
            <path d="M19.07 4.93l-1.41 1.41"/>
            <path d="M15.947 12.65a4 4 0 0 0-5.925-4.128"/>
            <path d="M13 22H7a5 5 0 1 1 4.9-6H13a3 3 0 0 1 0 6Z"/>
          </svg>`,
          cloudy: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
            <path d="M17.5 19H9a7 7 0 1 1 6.71-9h1.79a4.5 4.5 0 1 1 0 9Z"/>
          </svg>`,
          fog: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
            <path d="M4 14h16"/>
            <path d="M4 18h16"/>
            <path d="M4 10h16"/>
            <path d="M4 6h16"/>
          </svg>`,
          drizzle: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
            <path d="M4 14.899A7 7 0 1 1 15.71 8h1.79a4.5 4.5 0 0 1 2.5 8.242"/>
            <path d="M8 19v1"/>
            <path d="M8 14v1"/>
            <path d="M16 19v1"/>
            <path d="M16 14v1"/>
            <path d="M12 21v1"/>
            <path d="M12 16v1"/>
          </svg>`,
          rain: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
            <path d="M4 14.899A7 7 0 1 1 15.71 8h1.79a4.5 4.5 0 0 1 2.5 8.242"/>
            <path d="M16 14v6"/>
            <path d="M8 14v6"/>
            <path d="M12 16v6"/>
          </svg>`,
          snow: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
            <path d="M4 14.899A7 7 0 1 1 15.71 8h1.79a4.5 4.5 0 0 1 2.5 8.242"/>
            <path d="M8 15h.01"/>
            <path d="M8 19h.01"/>
            <path d="M12 17h.01"/>
            <path d="M12 21h.01"/>
            <path d="M16 15h.01"/>
            <path d="M16 19h.01"/>
          </svg>`,
          thunderstorm: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
            <path d="M4 14.899A7 7 0 1 1 15.71 8h1.79a4.5 4.5 0 0 1 2.5 8.242"/>
            <path d="m9.2 22 3-7H8l4-7"/>
          </svg>`
        };
        return icons[iconType] || icons.clear;
      }

      async function fetchWeather() {
        const weatherIcon = document.getElementById("weatherIcon");
        const weatherText = document.getElementById("weatherText");
        const tempValue = document.getElementById("tempValue");

        try {
          // ã¾ãšä½ç½®æƒ…å ±ã‚’å–å¾—
          const position = await new Promise((resolve, reject) => {
            navigator.geolocation.getCurrentPosition(resolve, reject, {
              enableHighAccuracy: false,
              timeout: 10000,
              maximumAge: 300000 // 5åˆ†ã‚­ãƒ£ãƒƒã‚·ãƒ¥
            });
          });

          const { latitude, longitude } = position.coords;
          
          // Open-Meteo APIï¼ˆç„¡æ–™ã€APIã‚­ãƒ¼ä¸è¦ï¼‰
          const url = `https://api.open-meteo.com/v1/forecast?latitude=${latitude}&longitude=${longitude}&current=temperature_2m,weather_code&timezone=Asia%2FTokyo`;
          
          const response = await fetch(url);
          const data = await response.json();
          
          const temp = Math.round(data.current.temperature_2m);
          const weatherCode = data.current.weather_code;
          const weather = weatherCodeMap[weatherCode] || { text: "ä¸æ˜", icon: "clear" };
          
          weatherIcon.innerHTML = getWeatherIcon(weather.icon);
          weatherText.textContent = weather.text;
          tempValue.textContent = `${temp}Â°C`;

        } catch (error) {
          console.error("å¤©æ°—å–å¾—ã‚¨ãƒ©ãƒ¼:", error);
          weatherText.textContent = "å–å¾—å¤±æ•—";
          tempValue.textContent = "--Â°C";
        }
      }

      // ============================================
      // ç§»å‹•æ™‚é–“ï¼ˆä½ç½®æƒ…å ±ã‹ã‚‰è¨ˆç®—ï¼‰
      // ============================================
      let lastPosition = null;
      let totalTravelTime = 0;
      const MOVEMENT_THRESHOLD = 10; // 10mä»¥ä¸Šç§»å‹•ã§è¨˜éŒ²

      function initTravelTracking() {
        const savedData = localStorage.getItem("poinavi_travel_" + getTodayKey());
        if (savedData) {
          totalTravelTime = parseInt(savedData, 10) || 0;
        }
        updateTravelDisplay();
        
        // ä½ç½®æƒ…å ±ã®ç›£è¦–é–‹å§‹
        if (navigator.geolocation) {
          navigator.geolocation.watchPosition(
            handlePositionUpdate,
            (err) => console.log("ä½ç½®æƒ…å ±ã‚¨ãƒ©ãƒ¼:", err),
            { enableHighAccuracy: true, maximumAge: 60000, timeout: 30000 }
          );
        }
      }

      function handlePositionUpdate(position) {
        const now = Date.now();
        
        if (lastPosition) {
          const distance = calculateDistance(
            lastPosition.coords.latitude,
            lastPosition.coords.longitude,
            position.coords.latitude,
            position.coords.longitude
          );
          
          if (distance > MOVEMENT_THRESHOLD) {
            const timeDiff = (now - lastPosition.timestamp) / 1000 / 60; // åˆ†
            if (timeDiff < 30) { // 30åˆ†ä»¥å†…ã®ç§»å‹•ã®ã¿ã‚«ã‚¦ãƒ³ãƒˆ
              totalTravelTime += timeDiff;
              localStorage.setItem("poinavi_travel_" + getTodayKey(), Math.round(totalTravelTime));
              updateTravelDisplay();
            }
          }
        }
        
        lastPosition = {
          coords: position.coords,
          timestamp: now
        };
      }

      function calculateDistance(lat1, lon1, lat2, lon2) {
        const R = 6371e3; // åœ°çƒã®åŠå¾„ï¼ˆãƒ¡ãƒ¼ãƒˆãƒ«ï¼‰
        const Ï†1 = lat1 * Math.PI / 180;
        const Ï†2 = lat2 * Math.PI / 180;
        const Î”Ï† = (lat2 - lat1) * Math.PI / 180;
        const Î”Î» = (lon2 - lon1) * Math.PI / 180;

        const a = Math.sin(Î”Ï†/2) * Math.sin(Î”Ï†/2) +
                  Math.cos(Ï†1) * Math.cos(Ï†2) *
                  Math.sin(Î”Î»/2) * Math.sin(Î”Î»/2);
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));

        return R * c;
      }

      function updateTravelDisplay() {
        const travelEl = document.getElementById("travelTime");
        const hours = Math.floor(totalTravelTime / 60);
        const mins = Math.round(totalTravelTime % 60);
        
        if (hours > 0) {
          travelEl.textContent = `${hours}æ™‚é–“${mins}åˆ†`;
        } else {
          travelEl.textContent = `${mins}åˆ†`;
        }
      }

      // ============================================
      // æ­©æ•°ç®¡ç†
      // ============================================
      function getTodayKey() {
        const now = new Date();
        return `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,"0")}-${String(now.getDate()).padStart(2,"0")}`;
      }

      function getStepsData() {
        const data = localStorage.getItem("poinavi_steps");
        return data ? JSON.parse(data) : {};
      }

      function saveSteps(date, steps) {
        const data = getStepsData();
        data[date] = steps;
        localStorage.setItem("poinavi_steps", JSON.stringify(data));
      }

      function initSteps() {
        const stepsData = getStepsData();
        const todayKey = getTodayKey();
        const todaySteps = stepsData[todayKey] || 0;
        
        document.getElementById("stepsValue").textContent = todaySteps > 0 ? `${todaySteps.toLocaleString()}æ­©` : "--æ­©";
        document.getElementById("stepsInput").value = todaySteps > 0 ? todaySteps : "";
        
        renderStepsChart();
      }

      function initStepsInput() {
        const input = document.getElementById("stepsInput");
        const submitBtn = document.getElementById("stepsSubmit");
        
        submitBtn.addEventListener("click", function() {
          const steps = parseInt(input.value, 10);
          if (isNaN(steps) || steps < 0) {
            alert("æ­£ã—ã„æ­©æ•°ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
            return;
          }
          
          const todayKey = getTodayKey();
          saveSteps(todayKey, steps);
          document.getElementById("stepsValue").textContent = `${steps.toLocaleString()}æ­©`;
          renderStepsChart();
          
          // ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯
          submitBtn.textContent = "è¨˜éŒ²å®Œäº†!";
          submitBtn.style.backgroundColor = "#10b981";
          setTimeout(() => {
            submitBtn.textContent = "è¨˜éŒ²";
            submitBtn.style.backgroundColor = "";
          }, 1500);
        });
      }

      function renderStepsChart() {
        const chartEl = document.getElementById("stepsChart");
        const stepsData = getStepsData();
        
        // éå»7æ—¥åˆ†ã®ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
        const days = [];
        for (let i = 6; i >= 0; i--) {
          const d = new Date();
          d.setDate(d.getDate() - i);
          const key = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}-${String(d.getDate()).padStart(2,"0")}`;
          const dayLabel = ["æ—¥", "æœˆ", "ç«", "æ°´", "æœ¨", "é‡‘", "åœŸ"][d.getDay()];
          days.push({
            key: key,
            label: dayLabel,
            date: d.getDate(),
            steps: stepsData[key] || 0
          });
        }
        
        const maxSteps = Math.max(...days.map(d => d.steps), 10000);
        
        chartEl.innerHTML = days.map(d => {
          const heightPercent = maxSteps > 0 ? (d.steps / maxSteps) * 100 : 0;
          const isToday = d.key === getTodayKey();
          return `
            <div class="lab-history__bar-wrapper ${isToday ? 'lab-history__bar-wrapper--today' : ''}">
              <div class="lab-history__bar" style="height: ${Math.max(heightPercent, 2)}%"></div>
              <div class="lab-history__bar-label">${d.label}</div>
              <div class="lab-history__bar-value">${d.steps > 0 ? (d.steps >= 1000 ? Math.round(d.steps/1000) + 'k' : d.steps) : '-'}</div>
            </div>
          `;
        }).join("");
      }

      // ============================================
      // åˆæœŸåŒ–
      // ============================================
      document.addEventListener("DOMContentLoaded", function() {
        initTheme();
        initSettingsModal();
        initThemeToggle();
        initStartPageSelect();
        initResetButton();
        
        // æ™‚åˆ»æ›´æ–°
        updateDateTime();
        setInterval(updateDateTime, 1000);
        
        // å¤©æ°—å–å¾—
        fetchWeather();
        setInterval(fetchWeather, 600000); // 10åˆ†ã”ã¨
        
        // ç§»å‹•æ™‚é–“
        initTravelTracking();
        
        // æ­©æ•°
        initSteps();
        initStepsInput();
      });
    </script>
  </body>
</html>
